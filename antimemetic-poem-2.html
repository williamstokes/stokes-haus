<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mute swan in a dark room - antimemetic poetics</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Averia+Sans+Libre:wght@300;400;700&family=Crimson+Pro:wght@300;400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/antimemetic.css">
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-MJ4TBKVZF7"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-MJ4TBKVZF7', {
            'anonymize_ip': true
        });
    </script>
</head>
<body>
    <div class="container">
        <div class="poem-page">
            <h1 class="poem-title">Mute swan in a dark room</h1>
            <div class="epigraph">
                <div class="epigraph-attribution">after C.D. Wright</div>
                LEAR: ... you see how this world goes.<br>GLOUCESTER:
            </div>
            
            <div class="password-form">
                <input type="text" id="password-input" class="password-input" placeholder="password">
                <button id="submit-btn" class="submit-btn">submit</button>
                <div id="error-message" class="error-message"></div>
                <div id="attempts-info" class="attempts-info"></div>
                <div id="global-success-rate" class="global-success-rate"></div>
            </div>
            <div id="publication-date-before" class="publication-date"><em>Published December 19, 2025</em></div>
            <div id="difficulty-before" class="difficulty">difficulty: β</div>
            <div id="poem-attribution-before" class="poem-attribution">an original poem by Will Stokes</div>
            
            <div id="poem-content" class="poem-content"></div>
            <div id="publication-date-after" class="publication-date" style="display: none;"><em>Published December 19, 2025</em></div>
            <div id="difficulty-after" class="difficulty" style="display: none;">difficulty: β</div>
            <div id="poem-attribution-after" class="poem-attribution" style="display: none;">an original poem by Will Stokes</div>
            <button id="obscure-btn" class="obscure-btn">forget</button>
        </div>
        
        <a href="antimemetic-poetics.html" class="back-link">back</a>
        
        <div class="site-copyright">
            <p>© 2025 Will Stokes. All rights reserved.</p>
            <p style="margin-top: 0.5rem; font-size: 0.75rem;"><a href="privacy-policy.html" style="color: inherit; text-decoration: none; opacity: 0.5;">privacy policy</a></p>
        </div>
    </div>
    
    <script src="js/antimemetic.js"></script>
    <script id="encrypted-poem-data" type="text/plain">
        PLnDLVo4e5mIwu9j3Cg0YJ5DH6e9R8hmTk3tGWDq0dfkEzBc3whc2LBOo1MTua0cYI143xB+4aUhqmreifDMM4acG5iO7r2PHy5aNFlC3DEz1/gLrfQU/ISF/nP0kZyKBq+Vn5Rpp3QnJKIyKXcoecj6eKBf1oWu38UBT5MrwJTvMYxxjMPn0UH9oodZekSxRGYB1kA2qcXcWefOEqMNTt3ITzEE+I68SktB9Mw9DyUI2HAfuRP8IDG4YXCs9kwiSR4G/XkgAEzrW+qjQvDaOshz79wj0vaXvhFOlv/EESR11OxmdYy13d4f+pEyZjYctNVWaXOjOSIsCGB7Jmtz0Ao3VmHD+1iA/OzYrIo3pXL+TszzpxjQeHgj4Y8GWJ+8991GapSJqAGGxP7wXFgBbRLAoA4C/nMb/K2xqn1P8KKHUKcWo+pwWeDDX7CLIZuFqnDurIp/SZ9YxBurXIiFsV4BECnYdffK5/59b6XcpQbRjPXANMOGLPRDBPcrSZFD0Tjen8HMQZh9BgT4W4o3s/SSJcaQJRx0lQIlCs1mPwkWhXD6M2FZ4KSU0+l9OPo6SPa56+VzhmPB6XsDybnIxtD5oIowctYF9Vm6BxkjK4eK+Pv531Mm53ydMBiMqk1cfRPtznKkNdigzX8mGlPc3QInY1z0QwIgA49UxVOWL32+jTEltnJlrhXxP71+5TaelHmVkGIoo3trk5bRduGNl4LhKnCBcTtjF1DWGZdc9jETefcergy9b4kKHmYYNvpST3+erk4t26XJrP1963iu3LrheytOmY74wy15Jkc0yQp+akRNvAOGNNRB6T3wMms+Igpc+gTzlTWReqoWUr9cnuf+7lxWoIY5z3L1Y8RL60K/5HSTqEc+0nKycevUPC/d8nIFoPv8izfH9qsBRU3ynDyn5D6McP+GDe0VVwlNSQWw2x3hyYaw+VsZbUCd7rj/E31yGHcPnSNLz/BE3Uw4RK1hxckIV1gQmPVsSR0nWKaavO+MRZH84I1QXxm7fsiJLetAMcEPFDDw4Klm+YvGYQSdPdLjsA==
    </script>
    <script>
        // Poem configuration
        const POEM_ID = 2;
        const ACCEPTABLE_PASSWORDS = ["i see it feelingly", "i see it feelingly."]; // case insensitive
        const ENCRYPTED_FILE = 'poems/poem-2.encrypted';
        
        const passwordInput = document.getElementById('password-input');
        const submitBtn = document.getElementById('submit-btn');
        const errorMessage = document.getElementById('error-message');
        const poemContent = document.getElementById('poem-content');
        const obscureBtn = document.getElementById('obscure-btn');
        const attemptsInfo = document.getElementById('attempts-info');
        const passwordForm = document.querySelector('.password-form');
        const publicationDateBefore = document.getElementById('publication-date-before');
        const publicationDateAfter = document.getElementById('publication-date-after');
        const difficultyBefore = document.getElementById('difficulty-before');
        const difficultyAfter = document.getElementById('difficulty-after');
        const poemAttributionBefore = document.getElementById('poem-attribution-before');
        const poemAttributionAfter = document.getElementById('poem-attribution-after');
        
        // Update attempts info
        function updateAttemptsInfo() {
            const remaining = getRemainingAttempts(POEM_ID);
            const maxAttempts = POEM_ID * 10;
            if (remaining > 0) {
                attemptsInfo.textContent = `${remaining} of ${maxAttempts} attempts remaining`;
            } else {
                attemptsInfo.textContent = 'No attempts remaining. Try again tomorrow.';
            }
            // Update global success rate
            updateGlobalSuccessRate();
        }
        
        // Check if attempts exceeded
        function checkAttempts() {
            if (isAttemptsExceeded(POEM_ID)) {
                passwordInput.disabled = true;
                submitBtn.disabled = true;
                errorMessage.textContent = 'Maximum attempts exceeded. Attempt counter resets at midnight EST. Note: Due to limitations in current antimemetic containment technology, the decrypted password may be discoverable in the source directory for those who know where to look.';
                errorMessage.classList.add('show');
                trackAttemptsExceeded(POEM_ID);
                return false;
            }
            return true;
        }
        
        // Validate password (case insensitive) and return normalized password
        function isValidPassword(password) {
            const lowerPassword = password.toLowerCase().trim();
            const matchingPassword = ACCEPTABLE_PASSWORDS.find(p => p.toLowerCase() === lowerPassword);
            return matchingPassword || null;
        }
        
        // Show error
        function showError(message) {
            errorMessage.textContent = message;
            errorMessage.classList.add('show');
            setTimeout(() => {
                errorMessage.classList.remove('show');
            }, 5000);
        }
        
        // Load and decrypt poem
        async function loadPoem(password) {
            try {
                // Always read from embedded script tag (works for both file:// and http(s)://)
                const scriptTag = document.getElementById('encrypted-poem-data');
                if (!scriptTag) {
                    throw new Error('Encrypted poem data not found');
                }
                const encryptedBase64 = scriptTag.textContent.trim();
                if (encryptedBase64.includes('PLACEHOLDER')) {
                    throw new Error('Encrypted poem content not yet generated. Please generate it using generate-poem-2.html');
                }
                const decrypted = await decryptPoem(encryptedBase64, password);
                
                // Replace "/" with line breaks (for backwards compatibility)
                // If poem already has line breaks, this won't affect it
                const formattedPoem = decrypted.replace(/\s*\/\s*/g, '\n');
                poemContent.textContent = formattedPoem;
                poemContent.classList.add('show');
                obscureBtn.classList.add('show');
                
                // Hide password form when poem is shown
                passwordForm.style.display = 'none';
                
                // Hide publication date, difficulty, and attribution before, show after
                publicationDateBefore.style.display = 'none';
                publicationDateAfter.style.display = 'block';
                difficultyBefore.style.display = 'none';
                difficultyAfter.style.display = 'block';
                poemAttributionBefore.style.display = 'none';
                poemAttributionAfter.style.display = 'block';
                
                // Reset attempts on success
                resetAttempts(POEM_ID);
                
                // Track successful decryption
                trackPoemDecrypted(POEM_ID);
            } catch (error) {
                throw new Error('Incorrect password or failed to decrypt poem');
            }
        }
        
        // Track page view
        if (typeof gtag !== 'undefined') {
            gtag('config', 'G-MJ4TBKVZF7', {
                'page_path': '/antimemetic-poem-2.html',
                'page_title': 'Mute swan in a dark room - antimemetic poetics'
            });
            gtag('event', 'page_view', {
                'page_title': 'Mute swan in a dark room - antimemetic poetics',
                'page_location': window.location.href,
                'user_id': getUserId()
            });
        }
        
        // Handle submit
        submitBtn.addEventListener('click', async function() {
            if (!checkAttempts()) {
                return;
            }
            
            const password = passwordInput.value;
            if (!password) {
                showError('Please enter a password');
                return;
            }
            
            const normalizedPassword = isValidPassword(password);
            if (normalizedPassword) {
                try {
                    await loadPoem(normalizedPassword);
                    // Track successful password attempt
                    const attemptData = getAttemptData(POEM_ID);
                    const maxAttempts = POEM_ID * 10;
                    trackPasswordAttempt(POEM_ID, true, attemptData.count + 1, maxAttempts, password);
                } catch (error) {
                    showError(error.message);
                    // Track failed decryption (wrong password format but passed validation)
                    const attemptData = getAttemptData(POEM_ID);
                    const maxAttempts = POEM_ID * 10;
                    trackPasswordAttempt(POEM_ID, false, attemptData.count, maxAttempts, password);
                }
            } else {
                const attempts = incrementAttempts(POEM_ID);
                updateAttemptsInfo();
                const maxAttempts = POEM_ID * 10;
                
                // Track incorrect password attempt
                trackPasswordAttempt(POEM_ID, false, attempts, maxAttempts, password);
                
                if (isAttemptsExceeded(POEM_ID)) {
                    showError('Incorrect password. Maximum attempts exceeded. Attempt counter resets at midnight EST. Note: Due to limitations in current antimemetic containment technology, the decrypted password may be discoverable in the source directory for those who know where to look.');
                    passwordInput.disabled = true;
                    submitBtn.disabled = true;
                    trackAttemptsExceeded(POEM_ID);
                } else {
                    showError('Incorrect password. Try thinking sideways. Try not thinking. Attempt counter resets at midnight EST.');
                }
            }
        });
        
        // Handle Enter key
        passwordInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                submitBtn.click();
            }
        });
        
        // Handle forget button
        obscureBtn.addEventListener('click', function() {
            poemContent.classList.remove('show');
            obscureBtn.classList.remove('show');
            
            // Show password form again
            passwordForm.style.display = 'block';
            
            // Show publication date, difficulty, and attribution before, hide after
            publicationDateBefore.style.display = 'block';
            publicationDateAfter.style.display = 'none';
            difficultyBefore.style.display = 'block';
            difficultyAfter.style.display = 'none';
            poemAttributionBefore.style.display = 'block';
            poemAttributionAfter.style.display = 'none';
            
            // Track poem forgotten event
            trackPoemForgotten(POEM_ID);
            
            passwordInput.value = '';
            passwordInput.disabled = false;
            submitBtn.disabled = false;
            errorMessage.classList.remove('show');
            updateAttemptsInfo();
        });
        
        // Initialize
        updateAttemptsInfo();
        updateGlobalSuccessRate();
        checkAttempts();
    </script>
</body>
</html>

