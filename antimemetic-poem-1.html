<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shibboleth - antimemetic poetics</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Averia+Sans+Libre:wght@300;400;700&family=Crimson+Pro:wght@300;400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/antimemetic.css">
</head>
<body>
    <div class="container">
        <div class="poem-page">
            <h1 class="poem-title">Shibboleth</h1>
            <div class="epigraph">Roses are red, violets are</div>
            
            <div class="password-form">
                <input type="text" id="password-input" class="password-input" placeholder="password">
                <button id="submit-btn" class="submit-btn">submit</button>
                <div id="error-message" class="error-message"></div>
                <div id="attempts-info" class="attempts-info"></div>
            </div>
            
            <div id="poem-content" class="poem-content"></div>
            <button id="obscure-btn" class="obscure-btn">forget</button>
        </div>
        
        <a href="antimemetic-poetics.html" class="back-link">back</a>
    </div>
    
    <script src="js/antimemetic.js"></script>
    <script id="encrypted-poem-data" type="text/plain">
        WFkm9ZV7oSMwU5tFeF2bOaXImh8+eXNKxEHfbO7AfRhwLcx/Wj3qULQjGqQjTNxyi/uJzj7pEe2VTxFV3K8l36LG7RnOLqyF3PHmTEkUskGweBszByxyj85rTglItlR10oqHQdkaxkVqYSvK+1XcT6uy3//JRSHchpMFWgDQI2spYQI50ZHgfAz/Hx84EoCZR61AJmOBss1MnSRmBlg7WkQ0QBCJd/sIlgP7zkUNpXi5IsbGzIx5J452LtIDcnnCfEDjAXjqZNdAgwX/0MqXJo1k1ac3tUprxLtP4ShYzggtI5mo7DL7cpZohdXm9DnjnKhuEZbKSJhzzNYbTQVLuXKy/VMjiT475I3Sgl/r2h+JIHKWdL4TzW7E/mzvhWOyR8zy1KMbR8RMjYsb9pU68k5TJfw3QmRw0IEyQGBJ9UnW4EDmtr3I2m0Me3FO9qBOggDFItdCtMKhD6SGMT3/86xRZB6fGne6yoepTjWpePLA7jE4j81raukoJmpHFdY6annfp10kfhu31sS2hghYQsyA+gCbknCHDQH4/YbA1G1wsB53s3LQjupLhYX2JxXuxnu0oxBVe4mWiOx8DcXjQ47pQds3/ZS1fWbnHDX+s/7yajeDjEx151X+jWxgLMiuc44Oh6Bn2crNoHJ+DUuTSfLW6B5Dx6HngFtg0xMXT40fI7PH58diM2sOS50gwN8N
    </script>
    <script>
        // Poem configuration
        const POEM_ID = 1;
        const ACCEPTABLE_PASSWORDS = ['violet']; // case insensitive
        const ENCRYPTED_FILE = 'poems/poem-1.encrypted';
        
        const passwordInput = document.getElementById('password-input');
        const submitBtn = document.getElementById('submit-btn');
        const errorMessage = document.getElementById('error-message');
        const poemContent = document.getElementById('poem-content');
        const obscureBtn = document.getElementById('obscure-btn');
        const attemptsInfo = document.getElementById('attempts-info');
        const passwordForm = document.querySelector('.password-form');
        
        // Update attempts info
        function updateAttemptsInfo() {
            const remaining = getRemainingAttempts(POEM_ID);
            const maxAttempts = POEM_ID * 10;
            if (remaining > 0) {
                attemptsInfo.textContent = `${remaining} of ${maxAttempts} attempts remaining`;
            } else {
                attemptsInfo.textContent = 'No attempts remaining. Try again tomorrow.';
            }
        }
        
        // Check if attempts exceeded
        function checkAttempts() {
            if (isAttemptsExceeded(POEM_ID)) {
                passwordInput.disabled = true;
                submitBtn.disabled = true;
                errorMessage.textContent = 'Maximum attempts exceeded. Please try again tomorrow.';
                errorMessage.classList.add('show');
                return false;
            }
            return true;
        }
        
        // Validate password (case insensitive) and return normalized password
        function isValidPassword(password) {
            const lowerPassword = password.toLowerCase().trim();
            const matchingPassword = ACCEPTABLE_PASSWORDS.find(p => p.toLowerCase() === lowerPassword);
            return matchingPassword || null;
        }
        
        // Show error
        function showError(message) {
            errorMessage.textContent = message;
            errorMessage.classList.add('show');
            setTimeout(() => {
                errorMessage.classList.remove('show');
            }, 5000);
        }
        
        // Load and decrypt poem
        async function loadPoem(password) {
            const protocol = window.location.protocol;
            const isFileProtocol = protocol === 'file:';
            try {
                let encryptedBase64;
                
                // Check if we're using file:// protocol (local file)
                if (isFileProtocol) {
                    // Read from embedded script tag
                    const scriptTag = document.getElementById('encrypted-poem-data');
                    if (!scriptTag) {
                        throw new Error('Encrypted poem data not found');
                    }
                    encryptedBase64 = scriptTag.textContent.trim();
                } else {
                    // Use fetch for http/https (e.g., GitHub Pages)
                    const response = await fetch(ENCRYPTED_FILE);
                    if (!response.ok) {
                        throw new Error('Failed to load encrypted poem');
                    }
                    encryptedBase64 = await response.text();
                }
                const decrypted = await decryptPoem(encryptedBase64.trim(), password);
                
                // Replace "/" with line breaks
                const formattedPoem = decrypted.replace(/\s*\/\s*/g, '\n');
                poemContent.textContent = formattedPoem;
                poemContent.classList.add('show');
                obscureBtn.classList.add('show');
                
                // Hide password form when poem is shown
                passwordForm.style.display = 'none';
                
                // Reset attempts on success
                resetAttempts(POEM_ID);
            } catch (error) {
                throw new Error('Incorrect password or failed to decrypt poem');
            }
        }
        
        // Handle submit
        submitBtn.addEventListener('click', async function() {
            if (!checkAttempts()) {
                return;
            }
            
            const password = passwordInput.value;
            if (!password) {
                showError('Please enter a password');
                return;
            }
            
            const normalizedPassword = isValidPassword(password);
            if (normalizedPassword) {
                try {
                    await loadPoem(normalizedPassword);
                } catch (error) {
                    showError(error.message);
                }
            } else {
                const attempts = incrementAttempts(POEM_ID);
                updateAttemptsInfo();
                
                if (isAttemptsExceeded(POEM_ID)) {
                    showError('Incorrect password. Maximum attempts exceeded. Attempt counter resets at midnight EST.');
                    passwordInput.disabled = true;
                    submitBtn.disabled = true;
                } else {
                    showError('Incorrect password. Try thinking sideways. Try not thinking. Attempt counter resets at midnight EST.');
                }
            }
        });
        
        // Handle Enter key
        passwordInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                submitBtn.click();
            }
        });
        
        // Handle forget button
        obscureBtn.addEventListener('click', function() {
            poemContent.classList.remove('show');
            obscureBtn.classList.remove('show');
            
            // Show password form again
            passwordForm.style.display = 'block';
            
            passwordInput.value = '';
            passwordInput.disabled = false;
            submitBtn.disabled = false;
            errorMessage.classList.remove('show');
            updateAttemptsInfo();
        });
        
        // Initialize
        updateAttemptsInfo();
        checkAttempts();
    </script>
</body>
</html>

