<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shibboleth - antimemetic poetics</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Averia+Sans+Libre:wght@300;400;700&family=Crimson+Pro:wght@300;400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/antimemetic.css">
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-MJ4TBKVZF7"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-MJ4TBKVZF7', {
            'anonymize_ip': true
        });
    </script>
</head>
<body>
    <div class="container">
        <div class="poem-page">
            <h1 class="poem-title">Shibboleth</h1>
            <div class="epigraph">Roses are red, violets are</div>
            
            <div class="password-form">
                <input type="text" id="password-input" class="password-input" placeholder="password">
                <button id="submit-btn" class="submit-btn">submit</button>
                <div id="error-message" class="error-message"></div>
                <div id="attempts-info" class="attempts-info"></div>
            </div>
            <div id="publication-date-before" class="publication-date"><em>Published December 19, 2025</em></div>
            <div id="difficulty-before" class="difficulty">difficulty: α</div>
            <div id="poem-attribution-before" class="poem-attribution">an original poem by Will Stokes</div>
            
            <div id="poem-content" class="poem-content"></div>
            <div id="publication-date-after" class="publication-date" style="display: none;"><em>Published December 19, 2025</em></div>
            <div id="difficulty-after" class="difficulty" style="display: none;">difficulty: α</div>
            <div id="poem-attribution-after" class="poem-attribution" style="display: none;">an original poem by Will Stokes</div>
            <button id="obscure-btn" class="obscure-btn">forget</button>
        </div>
        
        <a href="antimemetic-poetics.html" class="back-link">back</a>
        
        <div class="site-copyright">
            <p>© 2025 Will Stokes. All rights reserved.</p>
            <p style="margin-top: 0.5rem; font-size: 0.75rem;"><a href="privacy-policy.html" style="color: inherit; text-decoration: none; opacity: 0.5;">privacy policy</a></p>
        </div>
    </div>
    
    <script src="js/antimemetic.js"></script>
    <script id="encrypted-poem-data" type="text/plain">
        WFkm9ZV7oSMwU5tFeF2bOaXImh8+eXNKxEHfbO7AfRhwLcx/Wj3qULQjGqQjTNxyi/uJzj7pEe2VTxFV3K8l36LG7RnOLqyF3PHmTEkUskGweBszByxyj85rTglItlR10oqHQdkaxkVqYSvK+1XcT6uy3//JRSHchpMFWgDQI2spYQI50ZHgfAz/Hx84EoCZR61AJmOBss1MnSRmBlg7WkQ0QBCJd/sIlgP7zkUNpXi5IsbGzIx5J452LtIDcnnCfEDjAXjqZNdAgwX/0MqXJo1k1ac3tUprxLtP4ShYzggtI5mo7DL7cpZohdXm9DnjnKhuEZbKSJhzzNYbTQVLuXKy/VMjiT475I3Sgl/r2h+JIHKWdL4TzW7E/mzvhWOyR8zy1KMbR8RMjYsb9pU68k5TJfw3QmRw0IEyQGBJ9UnW4EDmtr3I2m0Me3FO9qBOggDFItdCtMKhD6SGMT3/86xRZB6fGne6yoepTjWpePLA7jE4j81raukoJmpHFdY6annfp10kfhu31sS2hghYQsyA+gCbknCHDQH4/YbA1G1wsB53s3LQjupLhYX2JxXuxnu0oxBVe4mWiOx8DcXjQ47pQds3/ZS1fWbnHDX+s/7yajeDjEx151X+jWxgLMiuc44Oh6Bn2crNoHJ+DUuTSfLW6B5Dx6HngFtg0xMXT40fI7PH58diM2sOS50gwN8N
    </script>
    <script>
        // Poem configuration
        const POEM_ID = 1;
        const ACCEPTABLE_PASSWORDS = ['violet']; // case insensitive
        const ENCRYPTED_FILE = 'poems/poem-1.encrypted';
        
        const passwordInput = document.getElementById('password-input');
        const submitBtn = document.getElementById('submit-btn');
        const errorMessage = document.getElementById('error-message');
        const poemContent = document.getElementById('poem-content');
        const obscureBtn = document.getElementById('obscure-btn');
        const attemptsInfo = document.getElementById('attempts-info');
        const passwordForm = document.querySelector('.password-form');
        const publicationDateBefore = document.getElementById('publication-date-before');
        const publicationDateAfter = document.getElementById('publication-date-after');
        const difficultyBefore = document.getElementById('difficulty-before');
        const difficultyAfter = document.getElementById('difficulty-after');
        const poemAttributionBefore = document.getElementById('poem-attribution-before');
        const poemAttributionAfter = document.getElementById('poem-attribution-after');
        
        // Update attempts info
        function updateAttemptsInfo() {
            const remaining = getRemainingAttempts(POEM_ID);
            const maxAttempts = POEM_ID * 10;
            if (remaining > 0) {
                attemptsInfo.textContent = `${remaining} of ${maxAttempts} attempts remaining`;
            } else {
                attemptsInfo.textContent = 'No attempts remaining. Try again tomorrow.';
            }
        }
        
        // Check if attempts exceeded
        function checkAttempts() {
            if (isAttemptsExceeded(POEM_ID)) {
                passwordInput.disabled = true;
                submitBtn.disabled = true;
                errorMessage.textContent = 'Maximum attempts exceeded. Attempt counter resets at midnight EST. Note: Due to limitations in current antimemetic containment technology, the decrypted password may be discoverable in the source directory for those who know where to look.';
                errorMessage.classList.add('show');
                trackAttemptsExceeded(POEM_ID);
                return false;
            }
            return true;
        }
        
        // Validate password (case insensitive) and return normalized password
        function isValidPassword(password) {
            const lowerPassword = password.toLowerCase().trim();
            const matchingPassword = ACCEPTABLE_PASSWORDS.find(p => p.toLowerCase() === lowerPassword);
            return matchingPassword || null;
        }
        
        // Show error
        function showError(message) {
            errorMessage.textContent = message;
            errorMessage.classList.add('show');
            setTimeout(() => {
                errorMessage.classList.remove('show');
            }, 5000);
        }
        
        // Load and decrypt poem
        async function loadPoem(password) {
            try {
                // Always read from embedded script tag (works for both file:// and http(s)://)
                const scriptTag = document.getElementById('encrypted-poem-data');
                if (!scriptTag) {
                    throw new Error('Encrypted poem data not found');
                }
                const encryptedBase64 = scriptTag.textContent.trim();
                const decrypted = await decryptPoem(encryptedBase64, password);
                
                // Replace "/" with line breaks (for backwards compatibility)
                // If poem already has line breaks, this won't affect it
                const formattedPoem = decrypted.replace(/\s*\/\s*/g, '\n');
                poemContent.textContent = formattedPoem;
                poemContent.classList.add('show');
                obscureBtn.classList.add('show');
                
                // Hide password form when poem is shown
                passwordForm.style.display = 'none';
                
                // Hide publication date, difficulty, and attribution before, show after
                publicationDateBefore.style.display = 'none';
                publicationDateAfter.style.display = 'block';
                difficultyBefore.style.display = 'none';
                difficultyAfter.style.display = 'block';
                poemAttributionBefore.style.display = 'none';
                poemAttributionAfter.style.display = 'block';
                
                // Reset attempts on success
                resetAttempts(POEM_ID);
                
                // Track successful decryption
                trackPoemDecrypted(POEM_ID);
            } catch (error) {
                throw new Error('Incorrect password or failed to decrypt poem');
            }
        }
        
        // Track page view
        if (typeof gtag !== 'undefined') {
            gtag('config', 'G-MJ4TBKVZF7', {
                'page_path': '/antimemetic-poem-1.html',
                'page_title': 'Shibboleth - antimemetic poetics'
            });
            gtag('event', 'page_view', {
                'page_title': 'Shibboleth - antimemetic poetics',
                'page_location': window.location.href,
                'user_id': getUserId()
            });
        }
        
        // Handle submit
        submitBtn.addEventListener('click', async function() {
            if (!checkAttempts()) {
                return;
            }
            
            const password = passwordInput.value;
            if (!password) {
                showError('Please enter a password');
                return;
            }
            
            const normalizedPassword = isValidPassword(password);
            if (normalizedPassword) {
                try {
                    await loadPoem(normalizedPassword);
                    // Track successful password attempt
                    const attemptData = getAttemptData(POEM_ID);
                    const maxAttempts = POEM_ID * 10;
                    trackPasswordAttempt(POEM_ID, true, attemptData.count + 1, maxAttempts);
                } catch (error) {
                    showError(error.message);
                    // Track failed decryption (wrong password format but passed validation)
                    const attemptData = getAttemptData(POEM_ID);
                    const maxAttempts = POEM_ID * 10;
                    trackPasswordAttempt(POEM_ID, false, attemptData.count, maxAttempts);
                }
            } else {
                const attempts = incrementAttempts(POEM_ID);
                updateAttemptsInfo();
                const maxAttempts = POEM_ID * 10;
                
                // Track incorrect password attempt
                trackPasswordAttempt(POEM_ID, false, attempts, maxAttempts);
                
                if (isAttemptsExceeded(POEM_ID)) {
                    showError('Incorrect password. Maximum attempts exceeded. Attempt counter resets at midnight EST. Note: Due to limitations in current antimemetic containment technology, the decrypted password may be discoverable in the source directory for those who know where to look.');
                    passwordInput.disabled = true;
                    submitBtn.disabled = true;
                    trackAttemptsExceeded(POEM_ID);
                } else {
                    showError('Incorrect password. Try thinking sideways. Try not thinking. Attempt counter resets at midnight EST.');
                }
            }
        });
        
        // Handle Enter key
        passwordInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                submitBtn.click();
            }
        });
        
        // Handle forget button
        obscureBtn.addEventListener('click', function() {
            poemContent.classList.remove('show');
            obscureBtn.classList.remove('show');
            
            // Show password form again
            passwordForm.style.display = 'block';
            
            // Show publication date, difficulty, and attribution before, hide after
            publicationDateBefore.style.display = 'block';
            publicationDateAfter.style.display = 'none';
            difficultyBefore.style.display = 'block';
            difficultyAfter.style.display = 'none';
            poemAttributionBefore.style.display = 'block';
            poemAttributionAfter.style.display = 'none';
            
            // Track poem forgotten event
            trackPoemForgotten(POEM_ID);
            
            passwordInput.value = '';
            passwordInput.disabled = false;
            submitBtn.disabled = false;
            errorMessage.classList.remove('show');
            updateAttemptsInfo();
        });
        
        // Initialize
        updateAttemptsInfo();
        checkAttempts();
    </script>
</body>
</html>

